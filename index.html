<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AB Fit - Monitor de Sono</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css">

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000; 
            margin: 0; 
            padding: 0; 
        }
        .screen { 
            display: none; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            overflow-y: auto; 
            background-color: #000; 
        }
        .screen.active { 
            display: block; 
        }
        #splashScreen.fade-out { 
            opacity: 0; 
            transition: opacity 0.5s; 
        }

        .sleep-quality-excellent { color: #10b981; }
        .sleep-quality-good { color: #3b82f6; }
        .sleep-quality-fair { color: #f59e0b; }
        .sleep-quality-poor { color: #ef4444; }

        #volumeMeter { 
            width: 100%; 
            height: 10px; 
            background-color: #374151; 
            border-radius: 5px; 
            overflow: hidden; 
        }
        #volumeBar { 
            height: 100%; 
            width: 0%; 
            background-color: #3b82f6; 
            transition: width 0.1s linear; 
        }
        
        .sleep-phase-bar { 
            height: 20px; 
            border-radius: 4px; 
            margin-bottom: 5px; 
        }
        .sleep-phase-rem { background-color: #8b5cf6; }
        .sleep-phase-light { background-color: #3b82f6; }
        .sleep-phase-deep { background-color: #1e40af; }
        .sleep-phase-awake { background-color: #ef4444; }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s;
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body class="overscroll-none">

    <div id="splashScreen" class="w-full h-screen flex flex-col items-center justify-center bg-black">
        <img src="https://i.ibb.co/P9T5YQJ/logo-ab-fit-512.png" alt="Logo AB Fit" class="w-40 h-40">
        <h1 class="text-4xl font-bold text-white mt-4">AB<span class="text-red-500">FIT</span></h1>
    </div>

    <div id="appContainer" class="hidden h-screen flex flex-col max-w-lg mx-auto bg-black">
        <main class="flex-grow relative overflow-hidden">
            <!-- Telas existentes omitidas para brevidade -->
            
            <div id="sleepTrackerScreen" class="screen p-6 pt-10">
                <header class="flex items-center justify-between pb-4">
                    <button class="back-btn p-2 rounded-full hover:bg-gray-800" data-target="studentProfileScreen">
                        <i data-feather="arrow-left" class="text-gray-300"></i>
                    </button>
                    <h1 class="text-2xl font-bold text-white">Monitor de Sono</h1>
                    <div class="w-10"></div>
                </header>
                
                <div class="space-y-4 pb-24">
                    <!-- Card de Monitoramento Ativo -->
                    <div class="bg-gray-900 p-4 rounded-xl border border-gray-700 text-center">
                        <i class="fas fa-moon text-blue-400 text-5xl mb-4"></i>
                        <h2 class="text-xl font-bold text-white mb-2">Pronto para descansar?</h2>
                        <p class="text-gray-400 text-sm mb-6 font-bold">Coloque seu celular na cama, perto de você, e inicie o monitoramento para uma análise detalhada do seu sono.</p>
                        
                        <div id="sleep-tracker-controls">
                            <button id="startSleepBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg">
                                <i class="fas fa-play mr-2"></i> Iniciar Monitoramento
                            </button>
                        </div>
                        
                        <div id="sleep-tracker-active" class="hidden">
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <div class="bg-gray-800 p-3 rounded-lg">
                                    <h2 class="text-sm text-gray-400 font-bold">Duração</h2>
                                    <p id="sleepDuration" class="text-xl font-bold text-white">00:00:00</p>
                                </div>
                                <div class="bg-gray-800 p-3 rounded-lg">
                                    <h2 class="text-sm text-gray-400 font-bold">Movimentos</h2>
                                    <p id="sleepMovements" class="text-xl font-bold text-white">0</p>
                                </div>
                                <div class="bg-gray-800 p-3 rounded-lg">
                                    <h2 class="text-sm text-gray-400 font-bold">Picos de Ruído</h2>
                                    <p id="sleepNoises" class="text-xl font-bold text-white">0</p>
                                </div>
                            </div>
                            
                            <div class="my-4">
                                <p class="text-sm text-gray-400 mb-2 font-bold">Nível de Ruído Ambiente</p>
                                <div id="volumeMeter">
                                    <div id="volumeBar"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="bg-gray-800 p-3 rounded-lg">
                                    <h2 class="text-sm text-gray-400 font-bold">Roncos Detectados</h2>
                                    <p id="sleepSnoring" class="text-xl font-bold text-white">0</p>
                                </div>
                                <div class="bg-gray-800 p-3 rounded-lg">
                                    <h2 class="text-sm text-gray-400 font-bold">Qualidade do Sono</h2>
                                    <p id="sleepQuality" class="text-xl font-bold sleep-quality-excellent">Excelente</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h2 class="text-sm text-gray-400 mb-2 font-bold">Fases do Sono</h2>
                                <div class="flex space-x-1 mb-2">
                                    <div class="sleep-phase-bar sleep-phase-rem flex-1" title="REM"></div>
                                    <div class="sleep-phase-bar sleep-phase-light flex-1" title="Leve"></div>
                                    <div class="sleep-phase-bar sleep-phase-deep flex-1" title="Profundo"></div>
                                    <div class="sleep-phase-bar sleep-phase-awake flex-1" title="Acordado"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-400">
                                    <span>REM: <span id="rem-percentage">0%</span></span>
                                    <span>Leve: <span id="light-percentage">0%</span></span>
                                    <span>Profundo: <span id="deep-percentage">0%</span></span>
                                    <span>Acordado: <span id="awake-percentage">0%</span></span>
                                </div>
                            </div>
                            
                            <button id="stopSleepBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg">
                                <i class="fas fa-stop mr-2"></i> Parar e Salvar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Card de Histórico de Sono -->
                    <div class="bg-gray-900 p-4 rounded-xl border border-gray-700">
                        <h2 class="text-xl font-bold text-white mb-4 text-center">Seu Histórico de Sono</h2>
                        <div id="sleepHistoryList" class="space-y-3">
                            <p class="text-gray-400 text-center font-bold">Nenhum registro de sono.</p>
                        </div>
                    </div>
                    
                    <!-- Card de Estatísticas Gerais -->
                    <div class="bg-gray-900 p-4 rounded-xl border border-gray-700">
                        <h2 class="text-xl font-bold text-white mb-4 text-center">Estatísticas de Sono</h2>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-800 p-3 rounded-lg text-center">
                                <h3 class="text-sm text-gray-400 font-bold">Média de Duração</h3>
                                <p id="avgDuration" class="text-xl font-bold text-white">--:--</p>
                            </div>
                            <div class="bg-gray-800 p-3 rounded-lg text-center">
                                <h3 class="text-sm text-gray-400 font-bold">Qualidade Média</h3>
                                <p id="avgQuality" class="text-xl font-bold sleep-quality-excellent">--</p>
                            </div>
                        </div>
                        <canvas id="sleepTrendChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </main>

        <footer id="bottom-nav" class="flex-shrink-0 bg-gray-900 border-t border-gray-700 hidden"></footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === BANCO DE DADOS E ESTADO GLOBAL ===
            let database = {};
            let currentStudentEmail = null;
            let currentCalendarDate = new Date();
            
            // Variáveis para o monitoramento de sono
            let sleepStartTime, sleepTimerInterval, audioContext, microphone, analyser, motionListener;
            let noiseCount = 0, movementCount = 0, snoringCount = 0;
            let sleepPhases = { rem: 0, light: 0, deep: 0, awake: 0 };
            let sleepPhaseTimer;
            let currentPhase = 'awake';
            let chart = null;

            // === INICIALIZAÇÃO E LÓGICAS EXISTENTES ===
            function loadDatabase() {
                const stored = localStorage.getItem("abfit_database");
                if (stored) {
                    database = JSON.parse(stored);
                } else {
                    database = {
                        users: [
                            { id: 1, name: "André Brito", email: "britodeandrade@gmail.com", photo: "https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/WsTwhcQeE99iAkUHmCmn/pub/3Zy4n6ZmWp9DW98VtXpO.jpeg" },
                            { id: 2, name: "Marcelly Bispo", email: "marcellybispo92@gmail.com", photo: "https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/WsTwhcQeE99iAkUHmCmn/pub/2VWhNV4eSyDNkwEzPGvq.jpeg" },
                            { id: 3, name: "Marcia Brito", email: "andrademarcia.ucam@gmail.com", photo: "https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/WsTwhcQeE99iAkUHmCmn/pub/huS3I3wDTHbXGY1EuLjf.jpg" },
                            { id: 4, name: "Liliane Torres", email: "lilicatorres@gmail.com", photo: "https://i.ibb.co/7j6x0gG/liliane-torres.jpg" }
                        ],
                        trainingPlans: {},
                        userRunningWorkouts: {
                            'britodeandrade@gmail.com': [
                                { date: "26/9", method: "FARTLEK", details: "5' AQ + 20' CO alternado entre CA : CO + 5' REC", speed: "8,5 Km/h", pace: "7:00/Km", time: "30 min" }
                            ]
                        },
                        outdoorWorkouts: {},
                        sleepHistory: {}
                    };
                    
                    database.users.forEach(user => {
                        database.trainingPlans[user.email] = database.trainingPlans[user.email] || { A: [], B: [], periodizacao: [], attendance: {} };
                        database.outdoorWorkouts[user.email] = database.outdoorWorkouts[user.email] || [];
                        database.sleepHistory[user.email] = database.sleepHistory[user.email] || [];
                    });
                    
                    saveDatabase();
                }
            }
            
            function saveDatabase() {
                localStorage.setItem("abfit_database", JSON.stringify(database));
            }
            
            function showScreen(screenId) {
                document.querySelectorAll(".screen").forEach(screen => {
                    screen.classList.remove("active");
                });
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.add("active");
                }
                
                document.getElementById("bottom-nav").style.display = screenId === "loginScreen" ? "none" : "flex";
                updateNav(screenId);
            }
            
            function updateNav(screenId) {
                document.querySelectorAll(".nav-btn").forEach(btn => {
                    const target = btn.dataset.target;
                    if ((target === "studentProfileScreen" && screenId.includes("studentProfile")) || target === screenId) {
                        btn.classList.add("text-red-500");
                        btn.classList.remove("text-gray-400", "hover:text-white");
                    } else {
                        btn.classList.remove("text-red-500");
                        btn.classList.add("text-gray-400", "hover:text-white");
                    }
                });
            }
            
            function populateUserSelection() {
                const container = document.getElementById("user-selection-container");
                container.innerHTML = database.users.map(user => `
                    <div class="user-card flex items-center p-3 bg-gray-800 rounded-xl border border-gray-700 cursor-pointer hover:bg-gray-700 transition" data-user-email="${user.email}">
                        <img src="${user.photo}" alt="${user.name}" class="w-12 h-12 rounded-full object-cover mr-4">
                        <div class="flex-grow">
                            <p class="font-bold text-white">${user.name}</p>
                            <span class="text-sm text-gray-400 font-bold">Acessar meu perfil</span>
                        </div>
                        <i data-feather="log-in" class="text-red-500"></i>
                    </div>
                `).join("");
                feather.replace();
            }
            
            function populateStudentList() {
                const container = document.getElementById("student-list-container");
                container.innerHTML = database.users.map(user => `
                    <div class="student-card flex items-center p-3 bg-gray-800 rounded-xl border border-gray-700 cursor-pointer hover:bg-gray-700 transition" data-student-id="${user.id}">
                        <img src="${user.photo}" alt="${user.name}" class="w-12 h-12 rounded-full object-cover mr-4">
                        <div class="flex-grow">
                            <p class="font-bold text-white">${user.name}</p>
                            <span class="text-sm text-gray-400 font-bold">Ver perfil completo</span>
                        </div>
                        <i data-feather="user" class="text-blue-500"></i>
                    </div>
                `).join("");
                feather.replace();
            }
            
            function populateStudentProfile(studentEmail) {
                currentStudentEmail = studentEmail;
                const student = database.users.find(s => s.email === studentEmail);
                if (!student) return;

                document.getElementById('student-profile-info').innerHTML = `
                    <div class="flex items-center mb-6">
                        <img src="${student.photo}" alt="${student.name}" class="w-20 h-20 rounded-full object-cover mr-4 border-2 border-gray-600">
                        <div>
                            <h1 class="text-2xl font-bold text-white">${student.name}</h1>
                            <p class="text-gray-400 font-bold">${student.email}</p>
                        </div>
                    </div>
                `;
                
                // ADICIONADO O BOTÃO DE SONO
                document.getElementById('student-profile-buttons').innerHTML = `
                    <button class="profile-action-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl flex flex-col items-center justify-center space-y-1" data-action="A">
                        <i data-feather="shield"></i>
                        <span class="text-xs font-bold">TREINO A</span>
                    </button>
                    <button class="profile-action-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl flex flex-col items-center justify-center space-y-1" data-action="B">
                        <i data-feather="zap"></i>
                        <span class="text-xs font-bold">TREINO B</span>
                    </button>
                    <button class="profile-action-btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl flex flex-col items-center justify-center space-y-1" data-action="corrida">
                        <i data-feather="trending-up"></i>
                        <span class="text-xs font-bold">CORRIDA</span>
                    </button>
                    <button class="profile-action-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-xl flex flex-col items-center justify-center space-y-1" data-action="periodizacao">
                        <i data-feather="calendar"></i>
                        <span class="text-xs font-bold">PERIODIZAÇÃO</span>
                    </button>
                    <button class="profile-action-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl flex flex-col items-center justify-center space-y-1" data-action="outdoor">
                        <i data-feather="map-pin"></i>
                        <span class="text-xs font-bold">OUTDOOR</span>
                    </button>
                    <button class="profile-action-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl flex flex-col items-center justify-center space-y-1" data-action="sono">
                        <i data-feather="moon"></i>
                        <span class="text-xs font-bold">SONO</span>
                    </button>
                `;
                feather.replace();
                renderCalendar();
            }
            
            function renderCalendar() {
                const attendance = database.trainingPlans[currentStudentEmail] && database.trainingPlans[currentStudentEmail].attendance || {};
                const monthYear = document.getElementById("calendar-month-year");
                const grid = document.getElementById("calendar-grid");
                
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                monthYear.textContent = currentCalendarDate.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
                grid.innerHTML = "";
                
                const firstDay = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startingDay = firstDay.getDay();
                
                for (let i = 0; i < startingDay; i++) {
                    grid.innerHTML += '<div class="calendar-day empty"></div>';
                }
                
                const today = new Date().toISOString().split("T")[0];
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
                    const attendanceData = attendance[dateString];
                    const isToday = dateString === today;
                    
                    grid.innerHTML += `<div class="calendar-day ${isToday ? "today" : ""} ${attendanceData ? `treino-${attendanceData.type}` : ""}">${day}</div>`;
                }
            }

            // === NOVAS FUNÇÕES: MONITORAMENTO DE SONO AVANÇADO ===
            function initializeSleepScreen() {
                document.getElementById('sleep-tracker-controls').style.display = 'block';
                document.getElementById('sleep-tracker-active').classList.add('hidden');
                document.getElementById('sleepDuration').textContent = '00:00:00';
                document.getElementById('sleepMovements').textContent = '0';
                document.getElementById('sleepNoises').textContent = '0';
                document.getElementById('sleepSnoring').textContent = '0';
                document.getElementById('sleepQuality').textContent = 'Excelente';
                document.getElementById('sleepQuality').className = 'text-xl font-bold sleep-quality-excellent';
                
                resetSleepPhases();
                updateSleepPhaseDisplay();
                
                noiseCount = 0;
                movementCount = 0;
                snoringCount = 0;
                
                renderSleepHistory();
                updateSleepStatistics();
            }
            
            function resetSleepPhases() {
                sleepPhases = { rem: 0, light: 0, deep: 0, awake: 0 };
                currentPhase = 'awake';
            }
            
            function updateSleepPhaseDisplay() {
                const total = sleepPhases.rem + sleepPhases.light + sleepPhases.deep + sleepPhases.awake;
                
                if (total === 0) {
                    document.getElementById('rem-percentage').textContent = '0%';
                    document.getElementById('light-percentage').textContent = '0%';
                    document.getElementById('deep-percentage').textContent = '0%';
                    document.getElementById('awake-percentage').textContent = '0%';
                    return;
                }
                
                document.getElementById('rem-percentage').textContent = Math.round((sleepPhases.rem / total) * 100) + '%';
                document.getElementById('light-percentage').textContent = Math.round((sleepPhases.light / total) * 100) + '%';
                document.getElementById('deep-percentage').textContent = Math.round((sleepPhases.deep / total) * 100) + '%';
                document.getElementById('awake-percentage').textContent = Math.round((sleepPhases.awake / total) * 100) + '%';
            }
            
            function updateSleepQuality() {
                const totalDuration = sleepPhases.rem + sleepPhases.light + sleepPhases.deep + sleepPhases.awake;
                if (totalDuration === 0) return;
                
                const deepSleepRatio = sleepPhases.deep / totalDuration;
                const awakeRatio = sleepPhases.awake / totalDuration;
                const movementRatio = movementCount / (totalDuration / 60); // movimentos por minuto
                const noiseRatio = noiseCount / (totalDuration / 60); // ruídos por minuto
                
                let qualityScore = 100;
                
                // Penalizações baseadas em fatores que afetam a qualidade do sono
                qualityScore -= awakeRatio * 40; // Muito tempo acordado
                qualityScore -= (1 - deepSleepRatio) * 20; // Pouco sono profundo
                qualityScore -= Math.min(movementRatio * 5, 20); // Muitos movimentos
                qualityScore -= Math.min(noiseRatio * 3, 15); // Muito ruído
                
                // Ajusta para garantir que está dentro dos limites
                qualityScore = Math.max(0, Math.min(100, qualityScore));
                
                let qualityText, qualityClass;
                
                if (qualityScore >= 80) {
                    qualityText = "Excelente";
                    qualityClass = "sleep-quality-excellent";
                } else if (qualityScore >= 60) {
                    qualityText = "Boa";
                    qualityClass = "sleep-quality-good";
                } else if (qualityScore >= 40) {
                    qualityText = "Regular";
                    qualityClass = "sleep-quality-fair";
                } else {
                    qualityText = "Ruim";
                    qualityClass = "sleep-quality-poor";
                }
                
                document.getElementById('sleepQuality').textContent = qualityText;
                document.getElementById('sleepQuality').className = `text-xl font-bold ${qualityClass}`;
                
                return qualityScore;
            }
            
            function simulateSleepPhase() {
                // Simula mudanças nas fases do sono
                // Em uma implementação real, isso seria baseado em algoritmos de análise de movimento e ruído
                const phases = ['rem', 'light', 'deep', 'awake'];
                const weights = [0.2, 0.4, 0.3, 0.1]; // Probabilidades para cada fase
                
                // Algoritmo simples para determinar a fase com base no tempo e movimentos
                const elapsedMinutes = Math.floor((Date.now() - sleepStartTime) / 60000);
                
                if (elapsedMinutes < 5) {
                    currentPhase = 'awake'; // Primeiros minutos geralmente acordado
                } else if (elapsedMinutes < 20) {
                    currentPhase = 'light'; // Entrando no sono leve
                } else if (elapsedMinutes % 90 < 10) {
                    currentPhase = 'rem'; // Ciclo REM a cada ~90 minutos
                } else if (elapsedMinutes % 90 < 60) {
                    currentPhase = 'light'; // Maior parte do ciclo é sono leve
                } else {
                    currentPhase = 'deep'; // Última parte do ciclo é sono profundo
                }
                
                // Ajusta baseado em movimentos - muitos movimentos indicam sono leve ou acordado
                if (movementCount > 5 && elapsedMinutes > 10) {
                    const movementRate = movementCount / elapsedMinutes;
                    if (movementRate > 0.3) {
                        currentPhase = 'awake';
                    } else if (movementRate > 0.1) {
                        currentPhase = 'light';
                    }
                }
                
                // Incrementa o contador da fase atual
                sleepPhases[currentPhase]++;
                
                updateSleepPhaseDisplay();
                updateSleepQuality();
            }
            
            async function startSleepTracking() {
                try {
                    // 1. Pedir permissão e capturar áudio
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    // 2. Iniciar monitoramento de movimento
                    if (window.DeviceMotionEvent) {
                        motionListener = (event) => {
                            const { x, y, z } = event.accelerationIncludingGravity;
                            const acceleration = Math.sqrt(x*x + y*y + z*z);
                            
                            // Um valor > 12 é um movimento brusco (ajuste conforme necessário)
                            if (acceleration > 12) {
                                movementCount++;
                                document.getElementById('sleepMovements').textContent = movementCount;
                            }
                        };
                        window.addEventListener('devicemotion', motionListener);
                    } else {
                        console.log("DeviceMotionEvent não suportado");
                    }

                    // 3. Iniciar timers e UI
                    sleepStartTime = Date.now();
                    document.getElementById('sleep-tracker-controls').style.display = 'none';
                    document.getElementById('sleep-tracker-active').classList.remove('hidden');

                    // Timer para duração do sono
                    sleepTimerInterval = setInterval(() => {
                        const diff = Math.floor((Date.now() - sleepStartTime) / 1000);
                        const h = String(Math.floor(diff / 3600)).padStart(2, '0');
                        const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
                        const s = String(diff % 60).padStart(2, '0');
                        document.getElementById('sleepDuration').textContent = `${h}:${m}:${s}`;
                        
                        // Análise de áudio
                        analyser.getByteFrequencyData(dataArray);
                        let sum = dataArray.reduce((a, b) => a + b, 0);
                        let average = sum / bufferLength;
                        document.getElementById('volumeBar').style.width = `${Math.min(average, 100)}%`;
                        
                        // Detecta ruídos (valor > 50) e roncos (valores específicos de frequência)
                        if (average > 50) {
                            noiseCount++;
                            document.getElementById('sleepNoises').textContent = noiseCount;
                            
                            // Detecção simples de ronco (frequências baixas)
                            const lowFreqAvg = dataArray.slice(0, 10).reduce((a, b) => a + b, 0) / 10;
                            if (lowFreqAvg > 70 && average > 60) {
                                snoringCount++;
                                document.getElementById('sleepSnoring').textContent = snoringCount;
                            }
                        }
                    }, 500); // Roda a cada meio segundo
                    
                    // Timer para simular fases do sono
                    sleepPhaseTimer = setInterval(simulateSleepPhase, 60000); // Atualiza a cada minuto

                } catch (err) {
                    alert('Erro ao acessar microfone ou sensores. Por favor, conceda a permissão.');
                    console.error(err);
                }
            }

            function stopSleepTracking() {
                // Parar timers e listeners
                clearInterval(sleepTimerInterval);
                clearInterval(sleepPhaseTimer);
                
                if (motionListener) {
                    window.removeEventListener('devicemotion', motionListener);
                }
                
                if (microphone) {
                    microphone.mediaStream.getTracks().forEach(track => track.stop());
                }
                
                if (audioContext) {
                    audioContext.close();
                }

                // Calcular qualidade final do sono
                const qualityScore = updateSleepQuality();
                
                // Salvar o registro
                const totalSeconds = Math.floor((Date.now() - sleepStartTime) / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                const durationFormatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                const sleepRecord = {
                    date: new Date().toISOString(),
                    duration: durationFormatted,
                    durationSeconds: totalSeconds,
                    movements: movementCount,
                    noises: noiseCount,
                    snoring: snoringCount,
                    quality: qualityScore,
                    phases: { ...sleepPhases }
                };
                
                if (!database.sleepHistory) database.sleepHistory = {};
                if (!database.sleepHistory[currentStudentEmail]) database.sleepHistory[currentStudentEmail] = [];
                database.sleepHistory[currentStudentEmail].push(sleepRecord);
                saveDatabase();

                // Resetar UI
                initializeSleepScreen();
            }

            function renderSleepHistory() {
                const historyContainer = document.getElementById('sleepHistoryList');
                const history = (database.sleepHistory && database.sleepHistory[currentStudentEmail]) || [];
                
                if (history.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-400 text-center font-bold">Nenhum registro de sono.</p>';
                    return;
                }
                
                historyContainer.innerHTML = history.slice().reverse().map(record => {
                    const date = new Date(record.date);
                    const dateStr = date.toLocaleDateString('pt-BR');
                    const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    let qualityClass, qualityText;
                    if (record.quality >= 80) {
                        qualityClass = "sleep-quality-excellent";
                        qualityText = "Excelente";
                    } else if (record.quality >= 60) {
                        qualityClass = "sleep-quality-good";
                        qualityText = "Boa";
                    } else if (record.quality >= 40) {
                        qualityClass = "sleep-quality-fair";
                        qualityText = "Regular";
                    } else {
                        qualityClass = "sleep-quality-poor";
                        qualityText = "Ruim";
                    }
                    
                    return `
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-white">${dateStr}</h4>
                                <span class="text-gray-400 text-sm font-bold">${timeStr}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div><span class="text-gray-400 font-bold">Duração:</span> <span class="text-white font-bold">${record.duration}</span></div>
                                <div><span class="text-gray-400 font-bold">Qualidade:</span> <span class="font-bold ${qualityClass}">${qualityText}</span></div>
                                <div><span class="text-gray-400 font-bold">Movimentos:</span> <span class="text-white font-bold">${record.movements}</span></div>
                                <div><span class="text-gray-400 font-bold">Roncos:</span> <span class="text-white font-bold">${record.snoring}</span></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function updateSleepStatistics() {
                const history = (database.sleepHistory && database.sleepHistory[currentStudentEmail]) || [];
                
                if (history.length === 0) {
                    document.getElementById('avgDuration').textContent = '--:--';
                    document.getElementById('avgQuality').textContent = '--';
                    document.getElementById('avgQuality').className = 'text-xl font-bold sleep-quality-excellent';
                    return;
                }
                
                // Calcular média de duração
                const totalSeconds = history.reduce((sum, record) => sum + record.durationSeconds, 0);
                const avgSeconds = totalSeconds / history.length;
                const avgHours = Math.floor(avgSeconds / 3600);
                const avgMinutes = Math.floor((avgSeconds % 3600) / 60);
                document.getElementById('avgDuration').textContent = `${String(avgHours).padStart(2, '0')}:${String(avgMinutes).padStart(2, '0')}`;
                
                // Calcular qualidade média
                const avgQuality = history.reduce((sum, record) => sum + record.quality, 0) / history.length;
                let qualityClass, qualityText;
                
                if (avgQuality >= 80) {
                    qualityClass = "sleep-quality-excellent";
                    qualityText = "Excelente";
                } else if (avgQuality >= 60) {
                    qualityClass = "sleep-quality-good";
                    qualityText = "Boa";
                } else if (avgQuality >= 40) {
                    qualityClass = "sleep-quality-fair";
                    qualityText = "Regular";
                } else {
                    qualityClass = "sleep-quality-poor";
                    qualityText = "Ruim";
                }
                
                document.getElementById('avgQuality').textContent = qualityText;
                document.getElementById('avgQuality').className = `text-xl font-bold ${qualityClass}`;
                
                // Atualizar gráfico de tendência
                updateSleepTrendChart(history);
            }
            
            function updateSleepTrendChart(history) {
                const ctx = document.getElementById('sleepTrendChart').getContext('2d');
                
                // Se já existe um gráfico, destrua-o
                if (chart) {
                    chart.destroy();
                }
                
                // Pegar os últimos 7 registros (ou todos se menos de 7)
                const recentHistory = history.slice(-7);
                const labels = recentHistory.map(record => {
                    const date = new Date(record.date);
                    return date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                });
                
                const qualityData = recentHistory.map(record => record.quality);
                const durationData = recentHistory.map(record => record.durationSeconds / 3600); // Converter para horas
                
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Qualidade do Sono (%)',
                                data: qualityData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                yAxisID: 'y',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Duração (horas)',
                                data: durationData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                yAxisID: 'y1',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                min: 0,
                                max: 100,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                min: 0,
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            },
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#9ca3af'
                                }
                            }
                        }
                    }
                });
            }

            // === EVENT LISTENERS ===
            document.body.addEventListener('click', (e) => {
                // Listener para as ações do perfil
                const actionBtn = e.target.closest('.profile-action-btn');
                if (actionBtn) {
                    const action = actionBtn.dataset.action;
                    if (action === 'sono') {
                        initializeSleepScreen();
                        showScreen('sleepTrackerScreen');
                    }
                    return;
                }

                // Listeners para os botões da tela de sono
                if (e.target.closest('#startSleepBtn')) startSleepTracking();
                if (e.target.closest('#stopSleepBtn')) stopSleepTracking();
            });

            // === INICIALIZAÇÃO DO APP ===
            function initApp() {
                feather.replace();
                loadDatabase();
                
                const splashScreen = document.getElementById("splashScreen");
                const appContainer = document.getElementById("appContainer");
                
                setTimeout(() => {
                    splashScreen.classList.add("fade-out");
                    setTimeout(() => {
                        splashScreen.style.display = "none";
                        appContainer.style.display = "flex";
                        appContainer.classList.remove("hidden");
                        populateUserSelection();
                        populateStudentList();
                        showScreen("loginScreen");
                    }, 500);
                }, 1500);
            }

            initApp();
        });
    </script>
</body>
</html>